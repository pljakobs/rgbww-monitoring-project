{
  "dashboard": {
    "id": null,
    "title": "Controllers Overview",
    "panels": [
      {
        "type": "table",
        "title": "Uptime and Free Heap",
        "datasource": "InfluxDB",
        "targets": [
          {
            "query": "from(bucket: 'rgbww')\n  |> range(start: -5m)\n  |> filter(fn: (r) => r._measurement == 'mqtt_consumer' and (r._field == 'uptime' or r._field == 'freeHeap'))\n  |> group(columns: ['topic'])\n  |> last()\n  |> pivot(rowKey: ['topic'], columnKey: ['_field'], valueColumn: '_value')\n  |> map(fn: (r) => ({ r with id: string(v: r.id) }))",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {},
          "overrides": []
        },
        "options": {
          "showHeader": true
        }
      },
      {
        "type": "table",
        "title": "All Controllers: ID, Uptime, Free Heap",
        "datasource": "InfluxDB",
        "targets": [
          {
            "query": "from(bucket: 'rgbww')\n  |> range(start: -5m)\n  |> filter(fn: (r) => r._measurement == 'mqtt_consumer' and (r._field == 'id' or r._field == 'uptime' or r._field == 'freeHeap'))\n  |> group(columns: ['topic'])\n  |> last()\n  |> pivot(rowKey: ['topic'], columnKey: ['_field'], valueColumn: '_value')",
            "refId": "E"
          }
        ],
        "fieldConfig": {
          "defaults": {},
          "overrides": []
        },
        "options": {
          "showHeader": true
        }
      },
      {
        "type": "stat",
        "title": "Online Controllers (2 min)",
        "datasource": "InfluxDB",
        "targets": [
          {
            "query": "from(bucket: 'rgbww')\n  |> range(start: -2m)\n  |> filter(fn: (r) => r._measurement == 'mqtt_consumer' and r._field == 'id')\n  |> keep(columns: ['_value'])\n  |> distinct(column: '_value')\n  |> count()",
            "refId": "B"
          }
        ]
      },
      {
        "type": "stat",
        "title": "Known Controllers (48h)",
        "datasource": "InfluxDB",
        "targets": [
          {
            "query": "from(bucket: 'rgbww')\n  |> range(start: -48h)\n  |> filter(fn: (r) => r._measurement == 'mqtt_consumer' and r._field == 'id')\n  |> keep(columns: ['_value'])\n  |> distinct(column: '_value')\n  |> count()",
            "refId": "C"
          }
        ]
      },
      {
        "type": "stat",
        "title": "Online/Total Ratio",
        "datasource": "InfluxDB",
        "targets": [
          {
            "query": "// Use math transform in Grafana to calculate ratio: online/known",
            "refId": "D"
          }
        ]
      }
    ],
    "schemaVersion": 30,
    "version": 1,
    "refresh": "10s"
  }
}
